################################################################################
# Ansible Inventory Generation
#
# SSH access goes through the Public Gateway bastion:
#   ssh -J bastion@<pgw_ip>:61000 user@<resource>.<pn>.internal
################################################################################

locals {
  esxi_public_ips = {
    for zone, server in scaleway_baremetal_server.esxi :
    zone => try([for ip in server.ips : ip.address if ip.version == "IPv4"][0], null)
  }

  bastion_ip   = scaleway_vpc_public_gateway_ip.bastion.address
  bastion_port = var.pgw_bastion_port
  bastion_jump = "bastion@${local.bastion_ip}:${local.bastion_port}"
  pn_name      = scaleway_vpc_private_network.bench.name

  ansible_ssh_args = "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ProxyJump=${local.bastion_jump}"
}

# =============================================================================
# Ansible Inventory
# =============================================================================

resource "local_file" "ansible_inventory" {
  count = var.generate_inventory ? 1 : 0

  depends_on = [
    scaleway_instance_server.proxy,
    scaleway_baremetal_server.esxi,
    scaleway_vpc_public_gateway.bastion,
    scaleway_vpc_gateway_network.bastion,
  ]

  filename = "${path.root}/../../ansible/inventory/hosts.yml"
  content  = <<-EOF
---
# Generated by Terraform - ${timestamp()}
# Storage Benchmark Infrastructure (iSCSI Architecture)
#
# iSCSI Target: ${data.scaleway_ipam_ip.proxy.address}:3260
#   LUN 1: vm-bench (${var.iscsi_lun_vm_size_gb}G) — direct iSCSI from Linux VMs
#   LUN 2: esxi-datastore (${var.iscsi_lun_esxi_size_gb}G) — VMFS6 on ESXi
#
# SSH via bastion: ${local.bastion_jump}

all:
  vars:
    ansible_python_interpreter: /usr/bin/python3
    ansible_ssh_common_args: '${local.ansible_ssh_args}'

    # Storage Proxy
    proxy_private_ip: "${data.scaleway_ipam_ip.proxy.address}"
    filestorage_mount: "${local.filestorage_mount}"
    filestorage_id: "${scaleway_file_filesystem.bench.id}"
    filestorage_size_gb: ${var.filestorage_size_gb}

    # iSCSI Configuration
    iscsi_target_iqn: "${local.iscsi_target_iqn}"
    iscsi_portal: "${data.scaleway_ipam_ip.proxy.address}:3260"
    iscsi_auth_user: "${local.iscsi_auth_user}"
    iscsi_auth_pass: "${local.iscsi_auth_pass}"
    iscsi_lun_vm_size_gb: ${var.iscsi_lun_vm_size_gb}
    iscsi_lun_esxi_size_gb: ${var.iscsi_lun_esxi_size_gb}

    # Bastion info
    bastion_host: "${local.bastion_ip}"
    bastion_port: ${local.bastion_port}
    pn_name: "${local.pn_name}"

    # Benchmark Configuration
    benchmark_dir: "/opt/benchmarks"
    results_dir: "/opt/benchmarks/results"
    fio_runtime: 60
    fio_size: "10G"

  children:
    # =========================================================================
    # iSCSI Proxy (POP2 Instance with File Storage)
    # =========================================================================
    nfs_proxy:
      hosts:
        ${var.project_name}-nfs-proxy:
          ansible_host: ${scaleway_instance_server.proxy.name}.${local.pn_name}.internal
          ansible_user: root
          private_ip: ${data.scaleway_ipam_ip.proxy.address}
          role: iscsi-proxy

    # =========================================================================
    # ESXi Hosts (Elastic Metal)
    # =========================================================================
    esxi_hosts:
      hosts:
%{for zone, node in local.esxi_nodes~}
        ${node.name}:
          ansible_host: ${node.name}.${local.pn_name}.internal
          ansible_user: root
          private_ip: ${node.ip}
          zone: ${zone}
          role: esxi
%{endfor~}

    # =========================================================================
    # Proxmox Nodes (existing cluster - Scenario A)
    # =========================================================================
%{if length(var.proxmox_nodes) > 0~}
    proxmox_nodes:
      hosts:
%{for name, ip in var.proxmox_nodes~}
        ${name}:
          ansible_host: ${ip}
          private_ip: ${lookup(var.proxmox_private_ips, name, "")}
          role: proxmox
%{endfor~}
%{endif~}

    # =========================================================================
    # Benchmark VMs
    #
    # Add VMs here after creating them on ESXi.
    # Two benchmark scenarios:
    #
    # 1. Direct iSCSI (VM mounts LUN 1 directly via iSCSI initiator):
    #    bench_scenario: "esxi-vm-iscsi-direct"
    #    bench_target_path: "/mnt/iscsi-bench/bench"
    #    iscsi_lun_id: 1
    #
    # 2. ESXi Datastore (VM disk lives on VMFS backed by LUN 2):
    #    bench_scenario: "esxi-vm-iscsi-datastore"
    #    bench_target_path: "/mnt/bench"  (local disk on VMFS)
    #    # No iSCSI config needed — ESXi manages the LUN
    # =========================================================================
    benchmark_vms:
      vars:
        ansible_ssh_extra_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
        iscsi_mount_path: "/mnt/iscsi-bench"
      hosts: {}
      # Example — direct iSCSI VM:
      #   esxi-bench-vm-direct:
      #     ansible_host: bench-vm.${local.pn_name}.internal
      #     ansible_user: fabien
      #     ansible_password: fabien
      #     ansible_become: true
      #     ansible_become_password: fabien
      #     bench_scenario: "esxi-vm-iscsi-direct"
      #     bench_target_path: "/mnt/iscsi-bench/bench"
      #     iscsi_lun_id: 1
      #
      # Example — VM on ESXi VMFS datastore:
      #   esxi-bench-vm-datastore:
      #     ansible_host: bench-vm-ds.${local.pn_name}.internal
      #     ansible_user: fabien
      #     ansible_password: fabien
      #     ansible_become: true
      #     ansible_become_password: fabien
      #     bench_scenario: "esxi-vm-iscsi-datastore"
      #     bench_target_path: "/mnt/bench"
EOF

  lifecycle {
    ignore_changes = [content]
  }
}

# =============================================================================
# Group Variables
# =============================================================================

resource "local_file" "ansible_group_vars" {
  count = var.generate_inventory ? 1 : 0

  filename = "${path.root}/../../ansible/inventory/group_vars/all.yml"
  content  = <<-EOF
---
# Generated by Terraform - ${timestamp()}

# =============================================================================
# SSH Bastion Configuration
# =============================================================================
bastion_host: "${local.bastion_ip}"
bastion_port: ${local.bastion_port}
bastion_jump: "${local.bastion_jump}"
pn_name: "${local.pn_name}"

# =============================================================================
# Storage Proxy Configuration
# =============================================================================
proxy_private_ip: "${data.scaleway_ipam_ip.proxy.address}"
filestorage_mount: "${local.filestorage_mount}"
filestorage_id: "${scaleway_file_filesystem.bench.id}"
filestorage_size_gb: ${var.filestorage_size_gb}

# =============================================================================
# iSCSI Configuration
#
# virtiofs CANNOT be re-exported via NFS (ESTALE on all file operations).
# Storage is exposed as iSCSI LUNs via tgtd on the proxy.
#
# LUN layout (single target, multiple LUNs):
#   Target: ${local.iscsi_target_iqn}
#   LUN 1: iscsi-lun-vm.img    (${var.iscsi_lun_vm_size_gb}G) — direct iSCSI for Linux VMs
#   LUN 2: iscsi-lun-esxi.img  (${var.iscsi_lun_esxi_size_gb}G) — VMFS6 datastore for ESXi
# =============================================================================
iscsi_target_iqn: "${local.iscsi_target_iqn}"
iscsi_portal: "${data.scaleway_ipam_ip.proxy.address}:3260"
iscsi_auth_user: "${local.iscsi_auth_user}"
iscsi_auth_pass: "${local.iscsi_auth_pass}"
iscsi_lun_vm_size_gb: ${var.iscsi_lun_vm_size_gb}
iscsi_lun_esxi_size_gb: ${var.iscsi_lun_esxi_size_gb}
iscsi_mount_path: "/mnt/iscsi-bench"
iscsi_backing_dir: "${local.filestorage_mount}"

# =============================================================================
# Network
# =============================================================================
private_network_subnet: "${var.private_network_subnet}"

# =============================================================================
# Benchmark Defaults
# =============================================================================
benchmark_dir: "/opt/benchmarks"
results_dir: "/opt/benchmarks/results"

# fio defaults
fio_runtime: 60
fio_size: "10G"
fio_iodepth: 32
fio_numjobs: 4
fio_ramp_time: 5

# ioping defaults
ioping_count: 100
ioping_size: "4k"

# bonnie++ defaults
bonnie_size_mb: 8192

# pgbench defaults
pgbench_scale: 100
pgbench_duration: 60
pgbench_clients: 10

# sysbench defaults
sysbench_tables: 10
sysbench_table_size: 1000000
sysbench_duration: 60
sysbench_threads: 8
EOF

  lifecycle {
    ignore_changes = [content]
  }
}
